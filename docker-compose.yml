volumes:
  django-static:

services:
  db:
    #image: "postgres:15-alpine"
    image: "postgis/postgis:16-3.4-alpine"
    container_name: django-local-postgis
    restart: unless-stopped
    volumes:
      - ./.volumes/pgdata:/var/lib/postgresql/data
    networks:
      - postgresnet
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-wodore}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-wodore}
      POSTGRES_DB: ${POSTGRES_DB:-wodore}
    ports:
      - "5432:5432"
  imagor:
    image: shumc/imagor:latest
    container_name: django-local-imagor
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped
    pull_policy: always
    network_mode: host
    volumes:
      - ./media:/mnt/data/source/media
      - ./media/imagor_data/storage:/mnt/data/storage
      - ./media/imagor_data/result:/mnt/data/result
    environment:
      PORT: 8079
      DEBUG: 1
      IMAGOR_UNSAFE: 1 # unsafe URL for testing
      IMAGOR_SECRET: ${IMAGOR_KEY:-my_key}
      IMAGOR_AUTO_WEBP: 1
      IMAGOR_AUTO_ACIF: 1
      IMAGOR_SIGNER_TYPE:
        sha256
        #IMAGOR_SIGNER_TRUNCATE: 40

      FILE_LOADER_BASE_DIR: /mnt/data/source # enable file loader by specifying base dir

      #HTTP_LOADER_ALLOWED_SOURCES: 127.0.0.1,localhost # enable HTTP loader for local URLs

      FILE_STORAGE_BASE_DIR: /mnt/data/storage # enable file storage by specifying base dir
      FILE_STORAGE_MKDIR_PERMISSION: 0755 # optional
      FILE_STORAGE_WRITE_PERMISSION: 0666 # optional

      FILE_RESULT_STORAGE_BASE_DIR: /mnt/data/result # enable file result storage by specifying base dir
      FILE_RESULT_STORAGE_MKDIR_PERMISSION: 0755 # optional
      FILE_RESULT_STORAGE_WRITE_PERMISSION: 0666 # optional
      IMAGOR_RESULT_STORAGE_PATH_STYLE: size
  martin:
    image: ghcr.io/maplibre/martin:latest
    container_name: django-local-martin
    restart: unless-stopped
    pull_policy: always
    ports:
      - "8075:3000"
    networks:
      - postgresnet
    volumes:
      - ./tile_server/config/martin.yaml:/config/martin.yaml:ro
      - ./server/apps/categories/assets/:/sprite/assets/:ro
      - ./tile_server/tests:/mbtiles:ro
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-wodore}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-wodore}
      POSTGRES_DB: ${POSTGRES_DB:-wodore}
      DATABASE_URL: "postgresql://${POSTGRES_USER:-wodore}:${POSTGRES_PASSWORD:-wodore}@db:5432/${POSTGRES_DB:-wodore}"
    command: --config /config/martin.yaml --webui enable-for-all
    depends_on:
      - db

        #web:
        #  <<: &web
        #    # Image name is changed in production:
        #    image: "wodore-backend:dev"
        #    build:
        #      target: development_build
        #      context: .
        #      dockerfile: ./docker/django/Dockerfile
        #      args:
        #        DJANGO_ENV: development
        #      cache_from:
        #        - "wodore-backend:dev"
        #        - "wodore-backend:latest"
        #        - "*"

        #    volumes:
        #      - django-static:/var/www/django/static
        #    depends_on:
        #      - db
        #    networks:
        #      - webnet
        #      - postgresnet
        #    env_file: ./config/.env
        #    environment:
        #      DJANGO_DATABASE_HOST: db

        #  command: python -Wd manage.py runserver 0.0.0.0:8000
        #  healthcheck:
        #    # We use `$$` here because:
        #    # one `$` goes to shell,
        #    # one `$` goes to `docker-compose.yml` escaping
        #    test: |
        #      /usr/bin/test $$(
        #        /usr/bin/curl --fail http://localhost:8000/health/?format=json
        #        --write-out "%{http_code}" --silent --output /dev/null
        #      ) -eq 200
        #    interval: 10s
        #    timeout: 5s
        #    retries: 5
        #    start_period: 30s

# This task is an example of how to extend existing ones:
#   some_worker:
#     <<: *web
#     command: python manage.py worker_process

networks:
  # Network for postgres, use it for services that need access to the db:
  postgresnet:
  imagor:
  # Network for your internals, use it by default:
  webnet:
